# Project Bedrock — InnovateMart Retail Store on AWS EKS (eu-west-1)

**Account:** `783479263698` • **Region:** `eu-west-1 (Europe/Ireland)`

**Mission:** Provision a production-grade EKS cluster with Terraform and deploy the `retail-store-sample-app` (with in-cluster dependencies). Provide read-only developer access and CI/CD for infra. Includes optional bonuses (managed DBs + ALB/Ingress + HTTPS).

---

## Architecture Overview

- **VPC (3 AZs):** Public and Private subnets, IGW, NAT per AZ.
- **EKS Cluster:** Control plane managed by AWS; worker nodes in **private** subnets.
- **In-cluster dependencies (default path):** MySQL, PostgreSQL, Redis, RabbitMQ via Bitnami charts.
- **Access:** kubectl via `aws eks update-kubeconfig`.
- **IAM:** Read-only developer IAM user mapped to a Kubernetes `view` group.
- **CI/CD:** GitHub Actions with OIDC → Terraform plan/apply.
- **Bonus:** RDS (Postgres/MySQL), DynamoDB, External Secrets Operator (ESO), AWS Load Balancer Controller (ALB) + Route 53 + ACM (HTTPS).

> Harden later: IRSA for controllers, separate node groups, HPA, observability, and tighter IAM policies.

---

## Getting Started

### 1) Bootstrap infrastructure (first run locally)
```bash
cd infra
terraform init
terraform apply -var-file=envs/prod/terraform.tfvars
```
> Outputs include `cluster_name` and read-only dev credentials (if not using SSO).

### 2) Configure kubeconfig
```bash
aws eks update-kubeconfig --name <cluster_name> --region eu-west-1
kubectl get nodes
```

### 3) Apply base namespaces & RBAC
```bash
kubectl apply -f k8s/base/namespaces.yaml
kubectl apply -f k8s/base/rbac/dev-viewer-clusterrole.yaml
```
Map the **IAM user** to Kubernetes group in `aws-auth`:
```bash
kubectl edit -n kube-system configmap/aws-auth
# Add:
# mapUsers: |
#   - userarn: arn:aws:iam::783479263698:user/innovatemart-dev-viewer
#     username: dev-viewer
#     groups:
#       - dev-viewers
```

### 4) Deploy app + in-cluster dependencies
Using **Helmfile** (requires `helmfile` installed):
```bash
cd k8s/apps/retail-store
helmfile apply
```
This installs Redis, MySQL, PostgreSQL, RabbitMQ, and a placeholder NGINX UI. Replace with your real retail UI/services as needed.

### 5) Developer read-only access
Share the IAM Access Key/Secret from Terraform output (or use SSO). Then:
```bash
aws configure
aws eks update-kubeconfig --name <cluster_name> --region eu-west-1
kubectl get pods -A
kubectl logs -n retail deploy/<service>
```
The `view` role prevents resource mutations.

---

### No domain? Options for access

- **Default (no domain):** Use the ALB's autogenerated DNS over **HTTP** (e.g., `k8s-...eu-west-1.elb.amazonaws.com`).  
- **Want HTTPS without buying a domain?** Put **CloudFront** in front of the ALB and use the default `*.cloudfront.net` domain (already HTTPS). ACM cert for CloudFront lives in **us-east-1**.  
- **Custom domain later:** Register a domain, request an ACM cert in `eu-west-1`, and add a Route 53 alias to the ALB.

---

## CI/CD for Infra (GitHub Actions + OIDC)

- On **PRs** touching `infra/**`: `terraform plan` runs.
- On **main** pushes: `terraform apply` runs.
- The workflow role: `arn:aws:iam::783479263698:role/gha-terraform-deployer` in `eu-west-1`.

> **Bootstrap note:** Create `gha-terraform-deployer` + GitHub OIDC provider once (via console or a separate Terraform stack). After that, the pipeline will work without static AWS keys.

---

## Bonus (pointers)

- **Managed Persistence:** create RDS (Postgres for orders, MySQL for catalog) + DynamoDB. Store creds in **AWS Secrets Manager** and sync to K8s with **External Secrets Operator**.  
- **Internet Ingress + HTTPS:** Install **AWS Load Balancer Controller**; use Ingress from `k8s/apps/retail-store/ui-ingress.yaml`. For HTTPS without owning a domain, consider CloudFront in front of the ALB.

---

## Repo Layout

```
infra/              # Terraform: VPC, EKS, IAM user (read-only), dynamic IRSA thumbprint
k8s/                # Namespaces/RBAC, Helmfile for sample deps & UI
.github/workflows/  # OIDC-based Terraform plan/apply (eu-west-1 / your account)
```

**Happy shipping!**
